FROM node:14 as build

ENV REACT_APP_FACEBOOK_CLIENT_ID=${REACT_APP_FACEBOOK_CLIENT_ID}
ENV REACT_APP_TWITTER_CLIENT_ID=${REACT_APP_TWITTER_CLIENT_ID}
ENV REACT_APP_INSTAGRAM_CLIENT_ID=${REACT_APP_INSTAGRAM_CLIENT_ID}
ENV REACT_APP_TOKEN_SERVICE_ENDPOINT=${REACT_APP_TOKEN_SERVICE_ENDPOINT}
ENV REACT_APP_BUCKET_URL=${REACT_APP_BUCKET_URL}
ENV REACT_APP_ENV=${REACT_APP_ENV}
ENV REACT_APP_MAP_BOX_API_KEY=${REACT_APP_MAP_BOX_API_KEY}
ENV REACT_APP_SYRF_API_URL=${REACT_APP_SYRF_API_URL}
ENV REACT_APP_SYRF_API_VERSION=${REACT_APP_SYRF_API_VERSION}
ENV REACT_APP_SYRF_API_DEV_TOKEN=${REACT_APP_SYRF_API_DEV_TOKEN}
ENV REACT_APP_SYRF_STREAMING_SERVER_SOCKETURL=${REACT_APP_SYRF_STREAMING_SERVER_SOCKETURL}

RUN mkdir /app

WORKDIR /app

COPY ./package.json /app/package.json
COPY ./yarn.lock /app/yarn.lock

RUN yarn install

COPY . .

RUN yarn test -- --watchAll=false --u

RUN yarn build

FROM nginx

COPY --from=build /app/build /usr/share/nginx/html

ADD default.conf /etc/nginx/conf.d/